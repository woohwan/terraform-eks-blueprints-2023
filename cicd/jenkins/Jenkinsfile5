pipeline {
  agent {
    kubernetes {
      inheritFrom 'kaniko'
    }
  }
  stages {
    stage('build') {
      steps {
        git branch: 'main', url: 'https://github.com/woohwan/cicd-app.git'
        script {
          // git commit hash 가겨오기
          def COMMIT_ID = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
          env.COMMIT_ID = COMMIT_ID
        }
        
        container('kaniko') {
            dir('jenkins/examples/fastapi') {
                
                // sh "/kaniko/executor --dockerfile=Dockerfile --context `pwd` --destination=whpark70/fastapi:$COMMIT_ID-$BUILD_NUMBER"
            }
        }
      }
    }
    stage('update gitops repo') {
      steps {
        git branch: 'main', url: 'https://github.com/woohwan/cicd-gitops.git', credentialsId: 'github-credential'
        //  use https://hub.docker.com/r/linuxserver/yq
        container('yq') {
            dir('manifests/fastapi') {
              sh('''yq -y -i '.spec.template.spec.containers[0].image = "whpark70/fastapi:$COMMIT_ID-$BUILD_NUMBER"' fastapi-deploy.yaml''')
            }
        }
        sh "`pwd`"
        sh '''
        git config --global user.name \\"woohwan\\"
        git config --global user.email \\"whpark70@naver.com\\"
        git add --all
        git commit -m \\"update\\"
        git push -u origin main
      '''
      }
    }
  }
}